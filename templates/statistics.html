<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h2 class="mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>

    <form method="get" id="filterForm" class="row g-3 align-items-end">
        <div class="col-md-6">
            <label for="date_range" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:</label>
            <div class="input-group">
                <input type="text" id="date_range" name="date_range" class="form-control" value="{{ date_range }}">
                <button type="button" class="btn btn-outline-secondary" id="openPicker">üìÖ</button>
            </div>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
    </form>

    <div class="row mt-5">

        <div class="col-md-7">
            <div id="lineChart"></div>
        </div>

        <div class="col-md-6">
            <div id="pieChart"></div>
        </div>


    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const fp = flatpickr("#date_range", {
        mode: "range",
        dateFormat: "Y-m-d"
    });

    document.getElementById("openPicker").addEventListener("click", function () {
        fp.open();
    });

    const labels = {{ labels|tojson }};
    const values = {{ values|tojson }};
    const currentDateRange = "{{ date_range }}";
    const categoryToId = {{ category_to_id_map|tojson }};
    const dayLabels = {{ day_labels|tojson }};
    const dayExpenses = {{ day_expenses|tojson }};
    const dayIncomes = {{ day_incomes|tojson }};

    const pieData = [{
        type: 'pie',
        labels: labels,
        values: values,
        textinfo: "label+percent",
        hoverinfo: "label+value",
        hole: 0.4
    }];

    const pieLayout = {
        title: "–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
        height: 400,
        width: 700
    };

    Plotly.newPlot("pieChart", pieData, pieLayout);

    document.getElementById('pieChart').on('plotly_click', function (data) {
        const clickedLabel = data.points[0].label;
        const categoryId = categoryToId[clickedLabel];

        if (categoryId !== undefined) {
            const url = `/operations?selected_category=${categoryId}&date_range=${encodeURIComponent(currentDateRange)}&selected_type=expense`;
            window.location.href = url;
        }
    });

    const lineData = [
        {
            type: 'scatter',
            mode: 'lines+markers',
            name: '–†–∞—Å—Ö–æ–¥—ã',
            x: dayLabels,
            y: dayExpenses,
            line: { color: 'red' },
            marker: { color: 'red' }
        },
        {
            type: 'scatter',
            mode: 'lines+markers',
            name: '–î–æ—Ö–æ–¥—ã',
            x: dayLabels,
            y: dayIncomes,
            line: { color: 'green' },
            marker: { color: 'green' }
        }
    ];

    const lineLayout = {
        title: "–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º",
        height: 400,
        width: 700,
        legend: {
            x: 1.05,
            y: 1,
            font: {
                size: 12
            }
        },
        margin: {
            r: 80
        },
        xaxis: {
            title: "–î–∞—Ç–∞",
            tickangle: -45
        },
        yaxis: {
            title: "–°—É–º–º–∞ (‚ÇΩ)"
        }
    };

    Plotly.newPlot("lineChart", lineData, lineLayout);

    document.getElementById('lineChart').on('plotly_click', function (data) {
        const clickedDate = data.points[0].x;
        const url = `/operations?date_range=${encodeURIComponent(clickedDate + ' to ' + clickedDate)}`;
        window.location.href = url;
    });
});
</script>

</body>
</html>
