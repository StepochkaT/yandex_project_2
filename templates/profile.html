{% extends "base.html" %}

{% block content %}
<!-- Обертка для центрирования -->
<div style="display: flex; justify-content: center;">
    <!-- Внутренний контейнер с фиксированной шириной -->
    <div style="max-width: 1000px; width: 100%; padding: 20px; box-sizing: border-box;">
        <h2><span class="badge bg-secondary">КРУТОЙ</span> личный кабинет</h2>
        <h4>Данные аккаунта:</h4>

        <!-- Основной блок с фото и формой -->
        <div style="display: flex; gap: 30px; align-items: flex-start; margin-top: 20px;">
            <!-- Блок с фото и кнопкой -->
            <div style="flex-direction: column; text-align: center; width: 200px;">
                <!-- Текущее фото -->
                <img id="profileImage" src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Фотография"
                     style="width: 200px; height: 200px; border-radius:10px; object-fit: cover; border: 1px solid #ccc; margin-bottom: 10px;">

                <!-- Кнопка для выбора файла -->
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button type="button" style="width: 100%;" onclick="document.getElementById('fileInput').click();">Выбрать фото</button>
            </div>

            <!-- Блок с формой редактирования данных -->
            <div style="flex: 1;">
                <!-- Форма редактирования данных -->
                <form action="{{ url_for('profile') }}" method="post">
                    <div class="mb-3">
                        <label for="email" class="form-label"><strong>Почта:</strong></label>
                        <input type="email" class="form-control" id="email" name="email"
                               value="{{ current_user.email }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label"><strong>Имя пользователя:</strong></label>
                        <input type="text" class="form-control" id="username" name="username"
                               value="{{ current_user.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="about" class="form-label"><strong>О себе:</strong></label>
                        <textarea class="form-control" id="about" name="about" rows="4" required>{{ current_user.about }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                    <a class="btn btn-outline-primary" href="/logout">Выйти из аккаунта</a>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Скрипт для выбора файла и отправки на сервер -->
<script>
  let selectedFile = null;

  document.getElementById('fileInput').addEventListener('change', function(event) {
    selectedFile = event.target.files[0];
    if (selectedFile) {
      // Предварительный просмотр
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profileImage').src = e.target.result;
      }
      reader.readAsDataURL(selectedFile);

      // Автоматическая загрузка файла
      uploadPhoto();
    }
  });

  function uploadPhoto() {
    if (!selectedFile) {
      alert('Пожалуйста, выберите файл перед загрузкой.');
      return;
    }

    const formData = new FormData();
    formData.append('photo', selectedFile);

    fetch('{{ url_for("upload_photo") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.url) {
        document.getElementById('profileImage').src = data.url;
      } else if (data.error) {
        alert('Ошибка: ' + data.error);
      }
    })
    .catch(error => {
      alert('Ошибка при загрузке: ' + error);
    });
  }
</script>
{% endblock %}